use proto9
use std

type msgtestcase = struct
	msg : proto9.msg
	data : byte[:]
;;

const testmsg = {
	var buf1, buf2, msg, packed, repacked
	
	buf1 = std.slalloc(4096)
	buf2 = std.slalloc(4096)

	var testcases : msgtestcase[:] = [
		[
			.msg=`proto9.Tversion [
				.tag=45,
				.size=9384,
				.version="9P2000",
			],
			.data=[0x13, 0x0, 0x0, 0x0, 0x64, 0x2d, 0x0, 0xa8, 0x24, 0x0, 0x0, 0x6, 0x0, 0x39, 0x50, 0x32, 0x30, 0x30, 0x30][:]
		],
		[
			.msg=`proto9.Rversion [
				.tag=45,
				.size=9384,
				.version="9P2000",
			],
			.data=[0x13, 0x0, 0x0, 0x0, 0x65, 0x2d, 0x0, 0xa8, 0x24, 0x0, 0x0, 0x6, 0x0, 0x39, 0x50, 0x32, 0x30, 0x30, 0x30][:]
		],
		[
			.msg=`proto9.Tauth [
				.tag=45,
				.afid=1234,
				.uname="someone",
				.aname="something",
			],
			.data=[0x1f, 0x0, 0x0, 0x0, 0x66, 0x2d, 0x0, 0xd2, 0x4, 0x0, 0x0, 0x7, 0x0, 0x73, 0x6f, 0x6d, 0x65, 0x6f, 0x6e, 0x65, 0x9, 0x0, 0x73, 0x6f, 0x6d, 0x65, 0x74, 0x68, 0x69, 0x6e, 0x67][:]
		],
		[
			.msg=`proto9.Rauth [
				.tag=45,
				.aqid=[.ty=0, .vers=0, .path=0]
			],
			.data=[0x14, 0x0, 0x0, 0x0, 0x67, 0x2d, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0][:]
		],
		[
			.msg=`proto9.Rauth [
				.tag=0x0101,
				.aqid=[.ty=0xff, .vers=0xffffffff, .path=0xffffffffffffffff]
			],
			.data=[0x14, 0x0, 0x0, 0x0, 0x67, 0x01, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff][:]
		],
		[
			.msg=`proto9.Rerror [
				.tag=45,
				.err="something something something",
			],
			.data=[0x26, 0x0, 0x0, 0x0, 0x6b, 0x2d, 0x0, 0x1d, 0x0, 0x73, 0x6f, 0x6d, 0x65, 0x74, 0x68, 0x69, 0x6e, 0x67, 0x20, 0x73, 0x6f, 0x6d, 0x65, 0x74, 0x68, 0x69, 0x6e, 0x67, 0x20, 0x73, 0x6f, 0x6d, 0x65, 0x74, 0x68, 0x69, 0x6e, 0x67][:]
		],
		[
			.msg=`proto9.Tattach [
				.tag=45,
				.fid=35243,
				.afid=90872354,
				.uname="",
				.aname="weee",
			],
			.data=[0x17, 0x0, 0x0, 0x0, 0x68, 0x2d, 0x0, 0xab, 0x89, 0x0, 0x0, 0x22, 0x9a, 0x6a, 0x5, 0x0, 0x0, 0x4, 0x0, 0x77, 0x65, 0x65, 0x65][:]
		],
		[
			.msg=`proto9.Rattach [
				.tag=45,
				.qid=[.ty=0, .vers=0, .path=0]
			],
			.data=[0x14, 0x0, 0x0, 0x0, 0x69, 0x2d, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0][:]
		],
		[
			.msg=`proto9.Tflush [
				.tag=45,
				.oldtag=23453,
			],
			.data=[0x9, 0x0, 0x0, 0x0, 0x6c, 0x2d, 0x0, 0x9d, 0x5b][:]
		],
		[
			.msg=`proto9.Rflush [
				.tag=45,
			],
			.data=[0x7, 0x0, 0x0, 0x0, 0x6d, 0x2d, 0x0][:]
		],
		[
			.msg=`proto9.Twalk [
				.tag=45,
				.fid=1234,
				.newfid=3452345,
				.nwnames=4,
				.wnames=[
					"ongo",
					"bongo",
					"filliyonko",
					"megatronko",
					"",
					"",
					"",
					"",
					"",
					"",
					"",
					"",
					"",
					"",
					"",
					"",
				],
			],
			.data=[0x36, 0x0, 0x0, 0x0, 0x6e, 0x2d, 0x0, 0xd2, 0x4, 0x0, 0x0, 0xb9, 0xad, 0x34, 0x0, 0x4, 0x0, 0x4, 0x0, 0x6f, 0x6e, 0x67, 0x6f, 0x5, 0x0, 0x62, 0x6f, 0x6e, 0x67, 0x6f, 0xa, 0x0, 0x66, 0x69, 0x6c, 0x6c, 0x69, 0x79, 0x6f, 0x6e, 0x6b, 0x6f, 0xa, 0x0, 0x6d, 0x65, 0x67, 0x61, 0x74, 0x72, 0x6f, 0x6e, 0x6b, 0x6f][:]
		],
		[
			.msg=`proto9.Rwalk [
				.tag=45,
				.nnwqid=1,
				.nwqid=[
					[.ty=0, .vers=0, .path=0],
					[.ty=0, .vers=0, .path=0],
					[.ty=0, .vers=0, .path=0],
					[.ty=0, .vers=0, .path=0],
					[.ty=0, .vers=0, .path=0],
					[.ty=0, .vers=0, .path=0],
					[.ty=0, .vers=0, .path=0],
					[.ty=0, .vers=0, .path=0],
					[.ty=0, .vers=0, .path=0],
					[.ty=0, .vers=0, .path=0],
					[.ty=0, .vers=0, .path=0],
					[.ty=0, .vers=0, .path=0],
					[.ty=0, .vers=0, .path=0],
					[.ty=0, .vers=0, .path=0],
					[.ty=0, .vers=0, .path=0],
					[.ty=0, .vers=0, .path=0],
				]
			],
			.data=[0x16, 0x0, 0x0, 0x0, 0x6f, 0x2d, 0x0, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, ][:]
		],
		[
			.msg=`proto9.Topen [
				.tag=45,
				.fid=21343,
				.mode=4,
			],
			.data=[0xc, 0x0, 0x0, 0x0, 0x70, 0x2d, 0x0, 0x5f, 0x53, 0x0, 0x0, 0x4][:]
		],
		[
			.msg=`proto9.Ropen [
				.tag=45,
				.qid=[.ty=0, .vers=0, .path=0],
				.iounit=1234123,
			],
			.data=[0x18, 0x0, 0x0, 0x0, 0x71, 0x2d, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xcb, 0xd4, 0x12, 0x0][:]
		],
		[
			.msg=`proto9.Tcreate [
				.tag=45,
				.fid=12343,
				.name="wakakaaka",
				.perm=proto9.Dmdir,
				.mode=4,
			],
			.data=[0x1b, 0x0, 0x0, 0x0, 0x72, 0x2d, 0x0, 0x37, 0x30, 0x0, 0x0, 0x9, 0x0, 0x77, 0x61, 0x6b, 0x61, 0x6b, 0x61, 0x61, 0x6b, 0x61, 0x0, 0x0, 0x0, 0x80, 0x4][:]
		],
		[
			.msg=`proto9.Rcreate [
				.tag=45,
				.qid=[.ty=0, .vers=0, .path=0],
				.iounit=1234123,
			],
			.data=[0x18, 0x0, 0x0, 0x0, 0x73, 0x2d, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xcb, 0xd4, 0x12, 0x0][:]
		],
		[
			.msg=`proto9.Tread [
				.tag=45,
				.fid=5343,
				.off=359842382234,
				.count=23423,
			],
			.data=[0x17, 0x0, 0x0, 0x0, 0x74, 0x2d, 0x0, 0xdf, 0x14, 0x0, 0x0, 0x9a, 0x1, 0x47, 0xc8, 0x53, 0x0, 0x0, 0x0, 0x7f, 0x5b, 0x0, 0x0][:]
		],
		[
			.msg=`proto9.Rread [
				.tag=45,
				.data="ooooh nooo it's full of data"
			],
			.data=[0x27, 0x0, 0x0, 0x0, 0x75, 0x2d, 0x0, 0x1c, 0x0, 0x0, 0x0, 0x6f, 0x6f, 0x6f, 0x6f, 0x68, 0x20, 0x6e, 0x6f, 0x6f, 0x6f, 0x20, 0x69, 0x74, 0x27, 0x73, 0x20, 0x66, 0x75, 0x6c, 0x6c, 0x20, 0x6f, 0x66, 0x20, 0x64, 0x61, 0x74, 0x61][:]
		],
		[
			.msg=`proto9.Twrite [
				.tag=45,
				.fid=254334,
				.off=21304978234,
				.data="something to write",
			],
			.data=[0x29, 0x0, 0x0, 0x0, 0x76, 0x2d, 0x0, 0x7e, 0xe1, 0x3, 0x0, 0x3a, 0x2b, 0xe0, 0xf5, 0x4, 0x0, 0x0, 0x0, 0x12, 0x0, 0x0, 0x0, 0x73, 0x6f, 0x6d, 0x65, 0x74, 0x68, 0x69, 0x6e, 0x67, 0x20, 0x74, 0x6f, 0x20, 0x77, 0x72, 0x69, 0x74, 0x65][:]
		],
		[
			.msg=`proto9.Rwrite [
				.tag=45,
				.count=12,
			],
			.data=[0xb, 0x0, 0x0, 0x0, 0x77, 0x2d, 0x0, 0xc, 0x0, 0x0, 0x0][:]
		],
		[
			.msg=`proto9.Tclunk [
				.tag=45,
				.fid=23123,
			],
			.data=[0xb, 0x0, 0x0, 0x0, 0x78, 0x2d, 0x0, 0x53, 0x5a, 0x0, 0x0][:]
		],
		[
			.msg=`proto9.Rclunk [
				.tag=45,
			],
			.data=[0x7, 0x0, 0x0, 0x0, 0x79, 0x2d, 0x0][:]
		],
		[
			.msg=`proto9.Tremove [
				.tag=45,
				.fid=1234,
			],
			.data=[0xb, 0x0, 0x0, 0x0, 0x7a, 0x2d, 0x0, 0xd2, 0x4, 0x0, 0x0][:]
		],
		[
			.msg=`proto9.Rremove [
				.tag=45,
			],
			.data=[0x7, 0x0, 0x0, 0x0, 0x7b, 0x2d, 0x0][:]
		],
		[
			.msg=`proto9.Tstat [
				.tag=45,
				.fid=12341234,
			],
			.data=[0xb, 0x0, 0x0, 0x0, 0x7c, 0x2d, 0x0, 0xf2, 0x4f, 0xbc, 0x0][:]
		],
		[
			.msg=`proto9.Rstat [
				.tag=45,
				.stat=[
					.ty=0,
					.dev=0,
					.qid=[.ty=0, .vers=0, .path=0],
					.mode=0,
					.atime=0,
					.mtime=0,
					.len=0,
					.name="",
					.uid="",
					.gid="",
					.muid="",
				]
			],
			.data=[0x3a, 0x0, 0x0, 0x0, 0x7d, 0x2d, 0x0, 0x31, 0x0, 0x2f, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0][:]
		],
	][:]

	for tc in testcases
		std.put("testing: {}\n", tc.msg)
		match proto9.packmsg(buf1, tc.msg)
		| `std.Some p:
			packed = p
		| `std.None:
			std.fatal("packing failed\n")
		;;
		if !std.sleq(packed, tc.data)
			std.fput(std.Err, "packing failed:\n")
			std.fatal("expected {r}\ngot      {r}\n", tc.data, packed)
		;;
		match proto9.unpackmsg(packed)
		| `std.Some m:
			msg = m
		| `std.None:
			std.fatal("reading {r} failed\n", packed)
		;;
		match proto9.packmsg(buf2, msg)
		| `std.Some p:
			repacked = p
		| `std.None:
	 		std.fatal("repacking failed\n")
	 	;;
		if !std.sleq(repacked, tc.data)
			std.fatal("repacking failed:\nexpected {r}\ngot {r}\n", tc.data, repacked)
		;;
	;;

}

const main = {
	testmsg()
}

