use proto9
use std

type msgtestcase = struct
	msg : proto9.msg
	data : byte[:]
;;

const testmsg = {
	var buf1, buf2, msg, packed, repacked
	
	buf1 = std.slalloc(4096)
	buf2 = std.slalloc(4096)

	var testcases : msgtestcase[:] = [
		[
			.msg=`proto9.Tversion [
				.tag=45,
				.size=9384,
				.version="9P2000",
			],
			.data=[0x13, 0x0, 0x0, 0x0, 0x64, 0x2d, 0x0, 0xa8, 0x24, 0x0, 0x0, 0x6, 0x0, 0x39, 0x50, 0x32, 0x30, 0x30, 0x30][:]
		],
		[
			.msg=`proto9.Rversion [
				.tag=45,
				.size=9384,
				.version="9P2000",
			],
			.data=[0x13, 0x0, 0x0, 0x0, 0x65, 0x2d, 0x0, 0xa8, 0x24, 0x0, 0x0, 0x6, 0x0, 0x39, 0x50, 0x32, 0x30, 0x30, 0x30][:]
		],
		[
			.msg=`proto9.Tauth [
				.tag=45,
				.afid=1234,
				.uname="someone",
				.aname="something",
			],
			.data=[0x1f, 0x0, 0x0, 0x0, 0x66, 0x2d, 0x0, 0xd2, 0x4, 0x0, 0x0, 0x7, 0x0, 0x73, 0x6f, 0x6d, 0x65, 0x6f, 0x6e, 0x65, 0x9, 0x0, 0x73, 0x6f, 0x6d, 0x65, 0x74, 0x68, 0x69, 0x6e, 0x67][:]
		],
		[
			.msg=`proto9.Rauth [
				.tag=45,
				.aqid=[.ty=0, .vers=0, .path=0]
			],
			.data=[0x14, 0x0, 0x0, 0x0, 0x67, 0x2d, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0][:]
		],
		[
			.msg=`proto9.Rauth [
				.tag=0x0101,
				.aqid=[.ty=0xff, .vers=0xffffffff, .path=0xffffffffffffffff]
			],
			.data=[0x14, 0x0, 0x0, 0x0, 0x67, 0x01, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff][:]
		],
		[
			.msg=`proto9.Rerror [
				.tag=45,
				.err="something something something",
			],
			.data=[0x26, 0x0, 0x0, 0x0, 0x6b, 0x2d, 0x0, 0x1d, 0x0, 0x73, 0x6f, 0x6d, 0x65, 0x74, 0x68, 0x69, 0x6e, 0x67, 0x20, 0x73, 0x6f, 0x6d, 0x65, 0x74, 0x68, 0x69, 0x6e, 0x67, 0x20, 0x73, 0x6f, 0x6d, 0x65, 0x74, 0x68, 0x69, 0x6e, 0x67][:]
		],
		[
			.msg=`proto9.Tattach [
				.tag=45,
				.fid=35243,
				.afid=90872354,
				.uname="",
				.aname="weee",
			],
			.data=[0x17, 0x0, 0x0, 0x0, 0x68, 0x2d, 0x0, 0xab, 0x89, 0x0, 0x0, 0x22, 0x9a, 0x6a, 0x5, 0x0, 0x0, 0x4, 0x0, 0x77, 0x65, 0x65, 0x65][:]
		],
		[
			.msg=`proto9.Rattach [
				.tag=45,
				.qid=[.ty=0, .vers=0, .path=0]
			],
			.data=[0x14, 0x0, 0x0, 0x0, 0x69, 0x2d, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0][:]
		],
		[
			.msg=`proto9.Tflush [
				.tag=45,
				.oldtag=23453,
			],
			.data=[0x9, 0x0, 0x0, 0x0, 0x6c, 0x2d, 0x0, 0x9d, 0x5b][:]
		],
		[
			.msg=`proto9.Rflush [
				.tag=45,
			],
			.data=[0x7, 0x0, 0x0, 0x0, 0x6d, 0x2d, 0x0][:]
		],
		[
			.msg=`proto9.Twalk [
				.tag=45,
				.fid=1234,
				.newfid=3452345,
				.nwnames=4,
				.wnames=[
					"ongo",
					"bongo",
					"filliyonko",
					"megatronko",
					"",
					"",
					"",
					"",
					"",
					"",
					"",
					"",
					"",
					"",
					"",
					"",
				],
			],
			.data=[0x36, 0x0, 0x0, 0x0, 0x6e, 0x2d, 0x0, 0xd2, 0x4, 0x0, 0x0, 0xb9, 0xad, 0x34, 0x0, 0x4, 0x0, 0x4, 0x0, 0x6f, 0x6e, 0x67, 0x6f, 0x5, 0x0, 0x62, 0x6f, 0x6e, 0x67, 0x6f, 0xa, 0x0, 0x66, 0x69, 0x6c, 0x6c, 0x69, 0x79, 0x6f, 0x6e, 0x6b, 0x6f, 0xa, 0x0, 0x6d, 0x65, 0x67, 0x61, 0x74, 0x72, 0x6f, 0x6e, 0x6b, 0x6f][:]
		],
	][:]

	for tc in testcases
		match proto9.packmsg(buf1, tc.msg)
		| `std.Some p:
			packed = p
		| `std.None:
			std.fatal("packing {} failed\n", tc.msg)
		;;
		if !std.sleq(packed, tc.data)
			std.fput(std.Err, "packing failed: {}\n", tc.msg)
			std.fatal("expected {r}\ngot      {r}\n", tc.data, packed)
		;;
		match proto9.unpackmsg(packed)
		| `std.Some m:
			msg = m
		| `std.None:
			std.fatal("reading {r} failed\n", packed)
		;;
		match proto9.packmsg(buf2, msg)
		| `std.Some p:
			repacked = p
		| `std.None:
	 		std.fatal("repacking {} failed\n", tc.msg)
	 	;;
		if !std.sleq(repacked, tc.data)
			std.fatal("repacking {} failed:\nexpected {r}\ngot      {r}\n", tc.msg, tc.data, repacked)
		;;
	;;

}

const main = {
	testmsg()
}

